<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematikkprøve</title>
    <!-- Google Fonts for kid-friendly typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        /* ============= VARIABLES ============= */
        :root {
            /* Colors - Colorblind-Friendly & Engaging Palette */
            --primary-color: #007BFF;      /* Vibrant Blue */
            --secondary-color: #FD7E14;    /* Bright Orange */
            --accent-color: #DC3545;       /* Red (for incorrect) */
            --accent-color-2: #FFC107;     /* Amber (for focus/highlight) */
            --background-color: #F8F9FA;   /* Light Gray */
            --card-color: #FFFFFF;         /* White */
            --text-color: #212529;         /* Dark Gray */
            --correct-color: #198754;      /* Dark Green (for correct) */
            --incorrect-color: #DC3545;    /* Red (already defined as accent) */

            /* Spacing */
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;

            /* Border radius */
            --radius-sm: 5px;
            --radius-md: 10px;
            --radius-lg: 15px;
            --radius-xl: 25px;
            --radius-round: 50%;
        }

        /* ============= BASE STYLES ============= */
        /* Global Reset */
        *, *:before, *:after {
            box-sizing: inherit;
        }

        html, body {
            width: 100%;
            max-width: 100vw;
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: var(--spacing-sm);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            box-sizing: border-box;
        }

        /* ============= TYPOGRAPHY ============= */
        h1 {
            font-family: 'Fredoka One', cursive;
            text-align: center;
            margin-bottom: var(--spacing-md);
            font-size: 1.8rem;
            color: var(--primary-color);
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.05);
        }

        /* ============= LAYOUT ============= */
        .container {
            width: 100%;
            max-width: 100%;
            min-height: auto;
            height: auto;
            margin: 0 auto;
            padding: var(--spacing-md);
            position: relative;
            background-color: var(--card-color);
            border-radius: var(--radius-lg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Controls Panel */
        .controls {
            margin: var(--spacing-sm) 0 var(--spacing-lg) 0;
            text-align: center;
            background: linear-gradient(145deg, #f0f9ff, #e6f7ff);
            padding: var(--spacing-md) var(--spacing-sm);
            border-radius: var(--radius-md);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* Problems Grid */
        .problems-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs) var(--spacing-sm);
            padding: var(--spacing-sm);
            background-color: #f9f9f9;
            border-radius: var(--radius-md);
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05);
            height: auto;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }


        /* ============= EQUATION COMPONENTS ============= */
        /* Number and operator formatting */
        .number-part {
            display: inline-block;
            width: 2ch;
            text-align: right;
            min-width: 1.5ch;
        }

        .operator {
            display: inline-block;
            width: 3ch;
            text-align: center;
            color: var(--accent-color);
            min-width: 1.5ch;
        }


        /* ============= CONTROLS COMPONENTS ============= */
        /* Operation and Number Selection */
        .operation-selection > div,
        .number-selection > div {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: var(--spacing-sm);
            margin: 0 auto;
        }

        .operation-selection label,
        .number-selection label {
            background: white;
            border-radius: var(--radius-xl);
            padding: 8px 15px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        /* Operation button gradients */
        .operation-selection label:nth-child(1) {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            border-color: #4dd0e1;
        }

        .operation-selection label:nth-child(2) {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-color: #ba68c8;
        }

        .operation-selection label:nth-child(3) {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-color: #66bb6a;
        }

        .operation-selection label:nth-child(4) {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-color: #ffa726;
        }

        /* Number buttons */
        .number-selection label {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-color: #64b5f6;
        }

        /* Disabled state for number buttons */
        .number-selection input[type="checkbox"]:disabled + span {
            color: #555; /* Darker gray for better contrast */
        }

        /* Using :has() for modern browsers */
        .number-selection label:has(input:disabled) {
            background: #ccc;
            border-color: #999;
            cursor: not-allowed;
        }

        /* Alternative for browsers that don't support :has() */
        .number-selection input[type="checkbox"]:disabled ~ span {
            color: #555; /* Darker gray for better contrast */
        }

        /* JavaScript will add this class to labels with disabled inputs */
        .number-selection label.disabled {
            background: #ccc;
            border-color: #999;
            cursor: not-allowed;
        }

        /* Grayscale for all number spans */
        .number-selection span {
            color: #333; /* Dark gray for all numbers */
        }

        /* Hover effects */
        .operation-selection label:hover,
        .number-selection label:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        /* Checked state */
        .operation-selection input[type="checkbox"]:checked + span::before,
        .number-selection input[type="checkbox"]:checked + span::before {
            content: "✓";
            margin-right: 5px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .controls label {
            margin-right: 15px;
            font-size: 12pt;
            cursor: pointer;
        }

        /* ============= TOGGLE SWITCHES ============= */
        .toggles-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .toggle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            min-width: 120px;
            width: 100%;
            max-width: 160px;
            transition: transform 0.2s;
        }

        .toggle-container:hover {
            transform: translateY(-3px);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 0 var(--spacing-sm);
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: var(--radius-round);
        }

        /* Toggle colors */
        input:checked + .slider {
            background-color: var(--primary-color);
        }

        .show-answers input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            margin: 0 var(--spacing-sm);
            text-align: center;
            color: var(--text-color);
        }

        .toggle-label.active {
            color: var(--primary-color);
        }

        /* ============= MEDIA QUERIES ============= */
        /* Small screens (mobile) */
        @media (max-width: 400px) {
            .number-part, .operator {
                margin-right: 1px;
                margin-left: 1px;
            }
        }

        @media (max-width: 576px) {
            .operation-selection label {
                font-size: 0.9em;
                padding: 6px 10px;
                margin-bottom: 5px;
                width: calc(50% - 15px);
            }

            .number-selection label {
                font-size: 0.9em;
                padding: 6px 8px;
                margin: 2px;
                min-width: 30px;
            }
        }

        /* Small tablets */
        @media (min-width: 576px) {
            h1 {
                font-size: 2.2rem;
                margin-bottom: var(--spacing-lg);
            }

            .problems-list {
                grid-template-columns: repeat(2, 1fr);
            }

            .toggles-container {
                gap: 15px;
                margin-top: var(--spacing-lg);
                justify-content: space-around;
            }

            .toggle-container {
                padding: var(--spacing-md);
                min-width: 140px;
                width: auto;
            }
        }

        /* Medium devices (tablets) */
        @media (min-width: 768px) {
            body {
                padding: var(--spacing-lg);
            }

            h1 {
                font-size: 2.5rem;
                margin-bottom: 8mm;
            }

            .container {
                padding: var(--spacing-lg);
                max-width: 95%;
            }

            .problems-list {
                grid-template-columns: repeat(3, 1fr);
                padding: var(--spacing-md);
            }

            .controls {
                padding: var(--spacing-lg);
            }
        }

        /* Large devices (desktops) */
        @media (min-width: 992px) {
            .container {
                padding: 10mm;
                max-width: 90%;
            }

            .problems-list {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Extra large devices */
        @media (min-width: 1200px) {
            .container {
                max-width: 1140px;
            }
        }

        /* High-DPI Screen Adjustments */
        @media screen and (min-resolution: 2dppx), screen and (-webkit-min-device-pixel-ratio: 2) {
            body {
                -webkit-text-size-adjust: 100%;
            }

            .problems-list {
                gap: 15px;
            }


            .operation-selection label,
            .number-selection label,
            .toggle-switch {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* Keep text color unchanged for show-answers toggle */
        .show-answers .toggle-label {
            color: inherit;
        }

        .show-answers {
            margin-top: 15px;
        }

        /* Problem layout styles */
        .problems-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .problem-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            padding: 6px 8px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* Responsive problem containers */
        @media (min-width: 576px) {
            .problem-container {
                padding: 8px 10px;
            }
        }

        @media (min-width: 768px) {
            .problem-container {
                padding: 8px 12px;
            }
        }

        .problem-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .problem-container label {
            margin-right: 8px;
            font-weight: 500;
        }

        .problem-container .feedback {
            margin-left: 8px;
            font-weight: bold;
        }

        /* Styles for answer inputs */
        .answer-input {
            width: 40px;
            height: 28px;
            font-size: 14pt;
            text-align: center;
            background-color: transparent;
            border: none;
            border-bottom: 2px solid var(--primary-color);
            padding: 2px 5px;
            /* Remove spinner buttons */
            appearance: textfield;
            -moz-appearance: textfield;
            transition: border-color 0.3s;
            margin-top: 2px; /* Add space when wrapping */
        }

        /* Responsive input field */
        @media (max-width: 400px) {
            .answer-input {
                width: 35px;
                height: 26px;
                font-size: 13pt;
            }
        }

        @media (min-width: 576px) {
            .answer-input {
                width: 45px;
            }
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--accent-color-2); /* Amber focus */
            box-shadow: none;
        }

        /* Remove spinner buttons in WebKit browsers (Chrome, Safari, Edge) */
        .answer-input::-webkit-outer-spin-button,
        .answer-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .correct-answer {
            color: var(--correct-color);
            font-weight: bold;
            position: relative;
            border-color: var(--correct-color);
            background-color: rgba(25, 135, 84, 0.05); /* Light green background */
        }

        .correct-answer::before {
            content: "✓";
            margin-right: 3px;
        }

        .incorrect-answer {
            color: var(--incorrect-color);
            font-weight: bold;
            position: relative;
            border-color: var(--incorrect-color);
            background-color: rgba(220, 53, 69, 0.05); /* Light red background */
        }

        .incorrect-answer::before {
            content: "✗";
            margin-right: 3px;
        }

        .invalid-answer {
            color: orange;
            font-weight: bold;
            border-color: orange;
            background-color: transparent;
        }

        .feedback {
            display: inline-block;
            margin-left: 8px;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Style feedback colors specifically */
        .correct-answer + .feedback {
            color: var(--correct-color);
        }

        .incorrect-answer + .feedback {
             color: var(--incorrect-color);
        }

        .number-selection {
            margin: 15px 0;
            text-align: center;
        }

        .number-selection label {
            margin-right: 8px;
            font-size: 12pt;
            display: inline-block;
            width: 30px;
            text-align: center;
        }

        .number-selection input {
            margin-right: 3px;
        }

        .number-selection label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 50%;
            background-color: var(--accent-color-2);
            color: var(--text-color);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin: 0 5px 5px 0;
        }

        .number-selection label:hover {
            transform: translateY(-3px);
            background-color: #FFE566;
        }

        .number-selection p,
        .operation-selection p {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .number-selection div,
        .operation-selection div {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px; /* Add some space below the selections */
        }

        .number-selection label,
        .operation-selection label {
            display: flex;
            align-items: center;
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .number-selection label:hover,
        .operation-selection label:hover {
            background-color: #ced4da;
        }

        .number-selection input[type="checkbox"],
        .operation-selection input[type="checkbox"] {
            display: none; /* Hide default checkbox */
        }

        .number-selection input[type="checkbox"]:checked + span,
        .operation-selection input[type="checkbox"]:checked + span {
            font-weight: bold;
            color: var(--primary-color);
        }

        .number-selection span,
        .operation-selection span {
            margin-left: 5px;
            font-size: 0.95em;
        }

        /* Gamification Styles */
        .gamification-panel {
            display: flex; 
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            padding: 10px 15px;
            margin: 10px auto;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 600px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-weight: bold;
            border: 1px solid rgba(77, 150, 255, 0.3);
            background-image: linear-gradient(to bottom, #ffffff, #f5f9ff);
        }

        .points-container, .streak-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .points-label, .streak-label {
            font-size: 1.1rem;
            color: #555;
        }

        .points-value {
            font-size: 1.5rem;
            color: var(--primary-color);
            min-width: 50px;
            text-align: center;
        }

        .streak-value {
            font-size: 1.5rem;
            color: var(--secondary-color);
            min-width: 30px;
            text-align: center;
        }

        .highest-streak {
            font-size: 0.9rem;
            color: #777;
            font-style: italic;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .points-increase {
            animation: pulse 0.5s ease;
        }

        /* Progress Bar Styles */
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 20px auto;
            height: 20px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.1);
            display: block;
            position: sticky;
            top: 0px;
            z-index: 100;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(77, 150, 255, 0.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15), inset 0 1px 3px rgba(0, 0, 0, 0.1);
            /* Add gradient background for better contrast */
            background-image: linear-gradient(to bottom, #ffffff, #f5f9ff);
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* Start at 0% */
            background-color: var(--correct-color); /* Orange progress bar */
            border-radius: 5px;
            transition: width 0.4s ease;
        }

        /* Class specifically for elements that shouldn't print */
        @media print {
            .no-print {
                display: none !important;
            }
        }

        /* ============= PRINT STYLES ============= */
        @media print {
            /* Reset body styles for print */
            body {
                font-family: 'Nunito', sans-serif;
                background: white;
                margin: 0;
                padding: 0;
                font-size: 10pt; /* Smaller base font size for print */
            }

            /* Reset container styles for print */
            .container {
                width: 210mm; /* A4 width */
                height: auto; /* Auto height */
                max-height: 297mm; /* Maximum A4 height */
                margin: 0;
                padding: 5mm; /* Reduced padding */
                box-shadow: none;
                border-radius: 0;
                background-color: white;
            }

            /* Reset problems list styles for print */
            .problems-list {
                background-color: white;
                box-shadow: none;
                padding: 0;
                grid-gap: 3px 6px; /* Slightly reduced grid gap */
                grid-template-columns: repeat(4, 1fr); /* Keep 4 columns */
            }

            /* Set page size with small margins */
            @page {
                size: A4;
                margin: 3mm; /* Small margin */
            }

            /* Hide controls, gamification elements, and decorative elements */
            .controls, .math-symbols, .gamification-panel, .progress-container, .no-print {
                display: none;
            }


            .answer-input {
                border: none;
                border-bottom: 1px solid #000; /* Black bottom border for print */
                background: transparent;
                width: 32px; /* Slightly wider */
                height: 20px; /* Taller input field */
                font-size: 12pt; /* Increased font size to match problem text */
                margin-left: 2px; /* Small left margin */
            }

            /* Hide feedback elements in print */
            .feedback {
                display: none;
            }


            /* Optimize problem container for print */
            .problem-container {
                padding: 4px 6px; /* Increased padding */
                margin-bottom: 4px; /* Increased margin */
                box-shadow: none;
                min-height: 26px; /* Ensure minimum height for taller problems */
            }

            /* Header and footer adjustments */
            h1 {
                font-size: 22pt; /* Larger header */
                margin-top: 0;
                margin-bottom: 5mm; /* Slightly increased margin */
                font-weight: bold; /* Ensure bold weight */
            }

            .footer {
                margin-top: 2mm; /* Slightly reduced margin */
                font-size: 9pt; /* Slightly smaller font */
            }
        }


        .answer-input {
            margin-left: 5px;
        }

        .footer p span {
            color: var(--secondary-color); /* Orange emphasis in footer */
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-color);
            margin: auto;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-button {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-md);
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
        }

        .close-button:hover {
            color: var(--accent-color);
        }

        .modal h2 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: var(--spacing-lg);
            font-family: 'Fredoka One', cursive;
        }

        .summary-stats {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--background-color);
            border-radius: var(--radius-md);
        }

        .summary-label {
            font-weight: bold;
            color: var(--text-color);
        }

        .summary-value {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .restart-button {
            display: block;
            width: 100%;
            padding: var(--spacing-md);
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Nunito', sans-serif;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .restart-button:hover {
            background-color: #e06c00;
        }
    </style>
</head>
<body>

    <div class="container">

        <h1>Matematikkprøve</h1>
        <div class="controls">
            <div class="operation-selection">
                <p>Velg regnearter:</p>
                <div>
                    <label>
                        <input type="checkbox" name="operation_type" value="multiply" checked onchange="createMathProblems()">
                        <span>Multiplikasjon (×)</span>
                    </label>
                    <label>
                        <input type="checkbox" name="operation_type" value="divide" onchange="createMathProblems()">
                        <span>Divisjon (÷)</span>
                    </label>
                    <label>
                        <input type="checkbox" name="operation_type" value="add" onchange="createMathProblems()">
                        <span>Addisjon (+)</span>
                    </label>
                    <label>
                        <input type="checkbox" name="operation_type" value="subtract" onchange="createMathProblems()">
                        <span>Subtraksjon (−)</span>
                    </label>
                </div>
            </div>
            <div class="number-selection">
                <p>Velg tallområde (for faktorer/operander):</p>
                <div>
                    <label>
                        <input type="checkbox" name="a_number" value="1" checked onchange="createMathProblems()">
                        <span>1</span>
                    </label>
                    <label>
                        <input type="checkbox" name="a_number" value="2" checked onchange="createMathProblems()">
                        <span>2</span>
                    </label>
                    <label>
                        <input type="checkbox" name="a_number" value="3" checked onchange="createMathProblems()">
                        <span>3</span>
                    </label>
                    <label>
                        <input type="checkbox" name="a_number" value="4" checked onchange="createMathProblems()">
                        <span>4</span>
                    </label>
                    <label>
                        <input type="checkbox" name="a_number" value="5" checked onchange="createMathProblems()">
                        <span>5</span>
                    </label>
                    <label>
                        <input type="checkbox" name="a_number" value="6" checked onchange="createMathProblems()">
                        <span>6</span>
                    </label>
                    <label>
                        <input type="checkbox" name="a_number" value="7" checked onchange="createMathProblems()">
                        <span>7</span>
                    </label>
                    <label>
                        <input type="checkbox" name="a_number" value="8" checked onchange="createMathProblems()">
                        <span>8</span>
                    </label>
                    <label>
                        <input type="checkbox" name="a_number" value="9" checked onchange="createMathProblems()">
                        <span>9</span>
                    </label>
                    <label>
                        <input type="checkbox" name="a_number" value="10" checked onchange="createMathProblems()">
                        <span>10</span>
                    </label>
                </div>
            </div>
            <div class="toggles-container">
                <div class="toggle-container">
                    <span class="toggle-label">Sortert rekkefølge</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="order-toggle" onchange="toggleOrder()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-container show-answers">
                    <span class="toggle-label" id="show-answers-label">Vis svar</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="show-results" onchange="toggleAnswers()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-container">
                    <span class="toggle-label" id="large-numbers-label">Kun store tall</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="large-numbers-toggle" onchange="toggleLargeNumbers()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="gamification-panel no-print" id="gamification-panel">
            <div class="points-container">
                <span class="points-label">Poeng:</span>
                <span class="points-value" id="points-display">0</span>
            </div>
            <div class="streak-container">
                <span class="streak-label">På rad:</span>
                <span class="streak-value" id="streak-display">0</span>
                <span class="highest-streak">(Beste: <span id="highest-streak">0</span>)</span>
            </div>
        </div>
        <div class="progress-container no-print" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="problems-list" id="problems-list">
            <!-- Problems will be generated here via JavaScript -->
        </div>
        <div class="footer">
            <p>Skriv svarene på linjene. <span style="color: var(--secondary-color);">Lykke til! 🚀</span></p>
        </div>

        <!-- Summary Modal -->
        <div id="summary-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2>Oppsummering</h2>
                <div class="summary-stats">
                    <div class="summary-item">
                        <span class="summary-label">Total poengsum:</span>
                        <span id="summary-points" class="summary-value">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Tid brukt:</span>
                        <span id="summary-time" class="summary-value">0 minutter</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Riktige svar:</span>
                        <span id="summary-correct" class="summary-value">0 av 0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Høyeste streak:</span>
                        <span id="summary-streak" class="summary-value">0</span>
                    </div>
                </div>
                <button id="restart-button" class="restart-button">Start på nytt</button>
            </div>
        </div>
    </div>

    <script>
        // Variables for progress tracking and gamification
        let totalProblems = 0;
        let answeredProblems = 0;
        let answeredIndices = new Set(); // Track which problems have been answered
        let currentPoints = 0;
        let currentStreak = 0;
        let highestStreak = 0;
        const TOTAL_PROBLEMS_COUNT = 100; // Total number of problems to generate

        // Variables for timing and summary
        let startTime = null;
        let endTime = null;

        // Helper function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Generate and distribute math problems based on selected numbers, operations, and total count.
         * @param {Array<number>} selectedNumbers - Array of numbers selected by the user.
         * @param {Array<string>} selectedOperations - Array of operation types ('add', 'subtract', 'multiply', 'divide').
         * @param {number} totalCount - The total number of problems to generate.
         * @param {boolean} largeNumbersOnly - Whether to only include problems where both a and b are 5 or higher.
         * @returns {Array<Object>} - An array of distributed problem objects.
         */
        function generateDistributedProblems(selectedNumbers, selectedOperations, totalCount, largeNumbersOnly) {
            const allPossibleProblems = [];

            // Generate all possible problems for the selections
            for (let i of selectedNumbers) {
                for (let j = 1; j <= 10; j++) { // Second operand range 1-10
                    for (let operation of selectedOperations) {
                        let problem = null;
                        switch (operation) {
                            case 'multiply':
                                problem = {
                                    a: i, b: j, result: i * j,
                                    equation: `<span class="number-part">${i}</span><span class="operator">×</span><span class="number-part">${j}</span><span class="operator">=</span>`,
                                    operationType: 'multiply'
                                };
                                break;
                            case 'divide':
                                // Ensure integer division: generate as k / j = i where k = i * j
                                // Also ensures divisor j is not 0 (since j starts at 1)
                                const k = i * j;
                                problem = {
                                    a: k, b: j, result: i,
                                    equation: `<span class="number-part">${k}</span><span class="operator">÷</span><span class="number-part">${j}</span><span class="operator">=</span>`,
                                    operationType: 'divide'
                                };
                                break;
                            case 'add':
                                problem = {
                                    a: i, b: j, result: i + j,
                                    equation: `<span class="number-part">${i}</span><span class="operator">+</span><span class="number-part">${j}</span><span class="operator">=</span>`,
                                    operationType: 'add'
                                };
                                break;
                            case 'subtract':
                                // Ensure non-negative result: use max(i,j) - min(i,j)
                                const num1 = Math.max(i, j);
                                const num2 = Math.min(i, j);
                                problem = {
                                    a: num1, b: num2, result: num1 - num2,
                                    equation: `<span class="number-part">${num1}</span><span class="operator">−</span><span class="number-part">${num2}</span><span class="operator">=</span>`,
                                    operationType: 'subtract'
                                };
                                break;
                        }
                        if (problem) {
                            // Only add the problem if it meets the large numbers criteria (if enabled)
                            if (!largeNumbersOnly || (problem.a >= 5 && problem.b >= 5)) {
                                allPossibleProblems.push(problem);
                            }
                        }
                    }
                }
            }

            // --- Start Distribution Logic ---
            const distributedProblems = [];
            const numOperations = selectedOperations.length;

            if (numOperations === 0 || allPossibleProblems.length === 0) {
                // Handle edge case: No operations selected or no possible problems generated
                // (e.g., if numbers 1-10 were somehow unselectable and none were checked)
                // Optionally, return a default set or an empty array
                console.warn("Cannot generate problems: No operations selected or no possible problems found.");
                 // Fallback: Generate 100 default multiplication problems (1x1 to 10x10)
                 for (let count = 0; count < totalCount; count++) {
                     const i = (count % 10) + 1;
                     const j = Math.floor(count / 10) + 1;
                     distributedProblems.push({
                         a: i, b: j, result: i * j,
                         equation: `<span class="number-part">${i}</span><span class="operator">×</span><span class="number-part">${j}</span><span class="operator">=</span>`,
                         operationType: 'multiply' // Mark as multiply for consistency
                     });
                 }
                 return shuffleArray(distributedProblems); // Shuffle the fallback set
            }

            // Calculate target counts per operation
            const baseCount = Math.floor(totalCount / numOperations);
            let remainder = totalCount % numOperations;
            const counts = {};
            selectedOperations.forEach(op => counts[op] = baseCount);
            for (let i = 0; i < remainder; i++) {
                counts[selectedOperations[i]]++;
            }

            // Select problems for each operation type, allowing repetition
            selectedOperations.forEach(op => {
                // Filter the unique problems available for this operation type
                const problemsForOp = allPossibleProblems.filter(p => p.operationType === op);

                if (problemsForOp.length > 0) {
                    // Add the required number of problems for this operation, repeating if necessary
                    for (let i = 0; i < counts[op]; i++) {
                        // Use modulo to cycle through available problems for this type
                        distributedProblems.push(problemsForOp[i % problemsForOp.length]);
                    }
                } else {
                    // This should ideally not happen if allPossibleProblems.length > 0 initially,
                    // but handle it just in case.
                    console.warn(`No problems found for operation type: ${op}. Skipping.`);
                }
            });

            // --- End Distribution Logic ---

            // Final shuffle to mix operations
            return shuffleArray(distributedProblems);
        }

        /**
         * Process problems layout (column-first vs random)
         */
        function processProblemsLayout(problems, isRandom) {
            // For numeric/sequential ordering, reorganize the array so that it fills
            // vertically (column-first) instead of horizontally (row-first)
            const rowsPerColumn = 25; // 25 rows per column with 4 columns = 100 problems
            const columnsCount = 4;

            // Create an array with the correct ordering
            const finalProblems = [];

            if (!isRandom) {
                // Organize problems in column-first order for sequential display
                // This ensures each column reads from top to bottom with sequential problems

                // First, sort the problems by 'a' then by 'b' for proper numeric ordering
                const sortedProblems = [...problems].sort((p1, p2) => {
                    if (p1.a !== p2.a) return p1.a - p2.a;
                    return p1.b - p2.b;
                });

                // Create a 2D array to represent our 4 columns with 25 rows each
                const grid = Array(columnsCount).fill().map(() => Array(rowsPerColumn).fill(null));

                // Fill the grid column by column
                let problemIndex = 0;
                for (let col = 0; col < columnsCount; col++) {
                    for (let row = 0; row < rowsPerColumn; row++) {
                        if (problemIndex < sortedProblems.length) {
                            grid[col][row] = sortedProblems[problemIndex++];
                        }
                    }
                }

                // Flatten the grid into our finalProblems array (reading row by row for HTML display)
                for (let row = 0; row < rowsPerColumn; row++) {
                    for (let col = 0; col < columnsCount; col++) {
                        if (grid[col][row]) {
                            finalProblems.push(grid[col][row]);
                        }
                    }
                }
            } else {
                // For random order, just use the shuffled array
                finalProblems.push(...shuffleArray([...problems]));
            }

            return finalProblems;
        }

        /**
         * Creates an interactive problem with input field and feedback
         * @param {HTMLElement} container - The container element for the problem
         * @param {Object} problem - The problem object with equation and result
         * @param {number} index - The index of the problem (for tabindex and ID)
         */
        function createInteractiveProblem(container, problem, index) {
            const inputId = `answer-${index}`;

            // Create the HTML structure
            container.innerHTML = problem.equation + 
                `<input type="text" id="${inputId}" class="answer-input" data-correct="${problem.result}" data-index="${index}" tabindex="${index+1}" maxlength="3" inputmode="numeric" pattern="[0-9]*">` +
                `<span id="feedback-${index}" class="feedback"></span>`;

            // Add event listeners after the element is added to the DOM
            setTimeout(() => {
                const input = document.getElementById(inputId);
                if (!input) return;

                // Check answer on Tab or Enter key
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab' || e.key === 'Enter') {
                        checkAnswer(inputId);

                        // If Enter was pressed, prevent form submission and move to next input
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const nextInput = document.getElementById(`answer-${index+1}`);
                            if (nextInput) nextInput.focus();
                        }
                    }
                });

                // Set start time when user focuses on any problem
                input.addEventListener('focus', function() {
                    // Record start time on first focus if not already set
                    if (startTime === null) {
                        startTime = new Date();
                        console.log('First problem focus at:', startTime);
                    }
                });

                // Also check on blur (when input loses focus)
                input.addEventListener('blur', function() {
                    if (this.value) {
                        checkAnswer(inputId);

                        // Update progress when user leaves the field with content
                        const index = parseInt(this.dataset.index);

                        // Only count each problem once and only if it has content
                        if (!answeredIndices.has(index)) {
                            answeredIndices.add(index);
                            answeredProblems++;
                            updateProgressBar();
                        }
                    }
                });
            }, 0);
        }

        /**
         * Validates and checks if an answer is correct
         * @param {string} inputId - The ID of the input element to check
         */
        function checkAnswer(inputId) {
            const input = document.getElementById(inputId);
            const feedback = document.getElementById('feedback-' + inputId.split('-')[1]);

            // Keep the original value (don't clear it)
            const originalValue = input.value;
            // Trim spaces from input value
            const trimmedValue = originalValue.trim();

            // Only update the input if we're removing spaces, not changing content
            if (trimmedValue !== originalValue && /^\s*\d+\s*$/.test(originalValue)) {
                input.value = trimmedValue;
            }

            // Handle different input cases
            if (trimmedValue === '') {
                resetInputState(input, feedback);
            } else if (!/^\d+$/.test(trimmedValue)) {
                markAsInvalid(input, feedback);
            } else {
                checkNumericAnswer(input, feedback, trimmedValue);
            }
        }

        /**
         * Reset input to default state
         */
        function resetInputState(input, feedback) {
            input.className = 'answer-input';
            feedback.textContent = '';
        }

        /**
         * Mark input as invalid (non-numeric)
         */
        function markAsInvalid(input, feedback) {
            input.className = 'answer-input invalid-answer';
            feedback.textContent = '!';
            feedback.style.color = 'orange';
        }

        /**
         * Check if numeric answer is correct
         */
        function checkNumericAnswer(input, feedback, value) {
            const userAnswer = parseInt(value);
            const correctAnswer = parseInt(input.dataset.correct);
            const wasAlreadyCorrect = input.className.includes('correct-answer');

            if (userAnswer === correctAnswer) {
                input.className = 'answer-input correct-answer';
                feedback.textContent = '✓';
                feedback.style.color = 'green';

                // Only award points if this is the first time getting it correct
                if (!wasAlreadyCorrect) {
                    // Award points and update streak
                    currentStreak++;
                    if (currentStreak > highestStreak) {
                        highestStreak = currentStreak;
                        document.getElementById('highest-streak').textContent = highestStreak;
                    }

                    // Calculate points (base + streak bonus)
                    const basePoints = 10;
                    const streakMultiplier = Math.floor(currentStreak / 5) + 1; // +1 multiplier every 5 correct answers
                    const pointsToAdd = basePoints * streakMultiplier;

                    // Add points
                    currentPoints += pointsToAdd;

                    // Update displays with animation
                    const pointsDisplay = document.getElementById('points-display');
                    const streakDisplay = document.getElementById('streak-display');

                    pointsDisplay.textContent = currentPoints;
                    streakDisplay.textContent = currentStreak;

                    // Add animation
                    pointsDisplay.classList.remove('points-increase');
                    void pointsDisplay.offsetWidth; // Trigger reflow
                    pointsDisplay.classList.add('points-increase');
                }
            } else {
                input.className = 'answer-input incorrect-answer';
                feedback.textContent = '✗';
                feedback.style.color = 'red';

                // Reset streak on wrong answer
                if (currentStreak > 0) {
                    currentStreak = 0;
                    document.getElementById('streak-display').textContent = currentStreak;
                }
            }
        }

        /**
         * Display problems based on current settings
         */
        function displayProblems(problems) {
            const problemsList = document.getElementById('problems-list');
            const showResults = document.getElementById('show-results').checked;
            const progressContainer = document.getElementById('progress-container');

            // Clear existing problems
            problemsList.innerHTML = '';

            // Store problems data globally for toggling answers
            window.problemsData = problems;

            // Update total problems count for progress tracking
            totalProblems = problems.length;

            // Progress bar and gamification panel are now shown by default in CSS

            // Reset progress tracking when problems are redisplayed
            answeredProblems = 0;
            answeredIndices.clear();
            updateProgressBar();

            // Display all problems
            for (let i = 0; i < problems.length; i++) {
                const problem = problems[i];
                const div = document.createElement('div');
                div.className = 'problem-container';

                createInteractiveProblem(div, problem, i);

                problemsList.appendChild(div);
            }
        }

        /**
         * Creates the math problems based on user selections.
         */
        function createMathProblems() {
            // Get selected numbers
            const selectedNumbers = [];
            const numberCheckboxes = document.querySelectorAll('input[name="a_number"]:checked');
            if (numberCheckboxes.length === 0) {
                 // Default to 1-10 if none selected?
                 for(let i=1; i<=10; i++) selectedNumbers.push(i);
                 // Maybe check the boxes visually too?
                 document.querySelectorAll('input[name="a_number"]').forEach(cb => cb.checked = true);
            } else {
                numberCheckboxes.forEach(checkbox => {
                    selectedNumbers.push(parseInt(checkbox.value));
                });
            }

            // Get selected operations
            const selectedOperations = [];
            const operationCheckboxes = document.querySelectorAll('input[name="operation_type"]:checked');
            if (operationCheckboxes.length === 0) {
                // Default to multiplication if none selected
                selectedOperations.push('multiply');
                // Check the multiplication box visually
                 const multiplyCheckbox = document.querySelector('input[name="operation_type"][value="multiply"]');
                 if (multiplyCheckbox) multiplyCheckbox.checked = true;
            } else {
                operationCheckboxes.forEach(checkbox => {
                    selectedOperations.push(checkbox.value);
                });
            }

            // Reset gamification values when controls are changed
            currentPoints = 0;
            currentStreak = 0;
            highestStreak = 0;
            document.getElementById('points-display').textContent = '0';
            document.getElementById('streak-display').textContent = '0';
            document.getElementById('highest-streak').textContent = '0';

            // Reset progress tracking
            answeredProblems = 0;
            answeredIndices.clear();
            updateProgressBar();

            // Get large numbers only preference
            const largeNumbersOnly = document.getElementById('large-numbers-toggle').checked;

            // Generate distributed problems
            const problems = generateDistributedProblems(selectedNumbers, selectedOperations, TOTAL_PROBLEMS_COUNT, largeNumbersOnly);

            // Get sorting preference
            const isRandom = !document.getElementById('order-toggle').checked;

            // Process layout (sorting/shuffling)
            const finalProblems = processProblemsLayout(problems, isRandom);

            // Display problems
            displayProblems(finalProblems);
        }

        /**
         * Toggle answers visibility without regenerating the test
         */
        function toggleAnswers() {
            const showResults = document.getElementById('show-results').checked;
            const gamificationPanel = document.getElementById('gamification-panel');
            const progressContainer = document.getElementById('progress-container');

            // Update label styling
            const showAnswersLabel = document.getElementById('show-answers-label');
            if (showResults) {
                showAnswersLabel.classList.add('active');

                // Fill in all input boxes with correct answers
                const inputs = document.querySelectorAll('.answer-input');
                inputs.forEach(input => {
                    const correctAnswer = input.getAttribute('data-correct');
                    input.value = correctAnswer;
                    input.readOnly = true;

                    // Reset any correct/incorrect styling
                    input.className = 'answer-input';

                    // Clear any existing feedback
                    const feedbackId = input.id.replace('answer', 'feedback');
                    const feedback = document.getElementById(feedbackId);
                    if (feedback) {
                        feedback.textContent = '';
                        feedback.style.color = ''; // Reset color
                    }
                });

                // Hide gamification elements
                gamificationPanel.style.display = 'none';
                progressContainer.style.display = 'none';

                // Reset gamification values
                currentPoints = 0;
                currentStreak = 0;
                highestStreak = 0;
                document.getElementById('points-display').textContent = '0';
                document.getElementById('streak-display').textContent = '0';
            } else {
                showAnswersLabel.classList.remove('active');

                // Clear all input boxes and make them editable again
                const inputs = document.querySelectorAll('.answer-input');
                inputs.forEach(input => {
                    input.value = '';
                    input.readOnly = false;
                    input.className = 'answer-input'; // Reset any correct/incorrect styling
                });

                // Show gamification elements again
                gamificationPanel.style.display = 'flex';
                progressContainer.style.display = 'block';

                // Reset progress
                answeredProblems = 0;
                answeredIndices.clear();
                updateProgressBar();
            }
        }

        /**
         * Toggle between sequential and random order
         */
        function toggleOrder() {
            // Get current state - checked = sequential order, unchecked = random order
            const isSorted = document.getElementById('order-toggle').checked;

            // Update toggle styling
            const toggleSwitch = document.querySelector('#order-toggle + .slider');
            if (isSorted) {
                toggleSwitch.classList.add('active');
            } else {
                toggleSwitch.classList.remove('active');
            }

            // Get large numbers only preference
            const largeNumbersOnly = document.getElementById('large-numbers-toggle').checked;

            // Regenerate problems with new order
            const problems = generateDistributedProblems(
                Array.from(document.querySelectorAll('input[name="a_number"]:checked')).map(cb => parseInt(cb.value)),
                Array.from(document.querySelectorAll('input[name="operation_type"]:checked')).map(cb => cb.value),
                TOTAL_PROBLEMS_COUNT,
                largeNumbersOnly
            );

            // Process layout (sorting/shuffling)
            const finalProblems = processProblemsLayout(problems, !isSorted);

            // Display problems using shared function
            displayProblems(finalProblems);
        }

        /**
         * Updates the progress when a user fills in an answer and leaves the field
         * @param {Event} event - The blur event
         */
        function updateProgress(event) {
            // Process the input value
            const input = event.target;
            if (!input.value || input.value.trim() === '') return; // Only count if field has content

            // Record start time on first answer attempt if not already set
            if (startTime === null) {
                startTime = new Date();
                console.log('First answer attempt at:', startTime);
            }

            const index = parseInt(input.dataset.index);

            // Only count each problem once
            if (!answeredIndices.has(index)) {
                answeredIndices.add(index);
                answeredProblems++;
                updateProgressBar();
            }
        }

        /**
         * Toggle between normal and large numbers only mode
         */
        function toggleLargeNumbers() {
            // Get current state - checked = large numbers only, unchecked = all numbers
            const largeNumbersOnly = document.getElementById('large-numbers-toggle').checked;

            // Update toggle styling
            const largeNumbersLabel = document.getElementById('large-numbers-label');
            if (largeNumbersOnly) {
                largeNumbersLabel.classList.add('active');

                // Disable and uncheck checkboxes for numbers 1-4
                document.querySelectorAll('input[name="a_number"]').forEach(checkbox => {
                    const value = parseInt(checkbox.value);
                    if (value >= 1 && value <= 4) {
                        checkbox.disabled = true;
                        checkbox.checked = false; // Uncheck the checkbox
                        // Add disabled class to parent label for styling
                        checkbox.parentElement.classList.add('disabled');
                    }
                });
            } else {
                largeNumbersLabel.classList.remove('active');

                // Enable checkboxes for numbers 1-4
                document.querySelectorAll('input[name="a_number"]').forEach(checkbox => {
                    const value = parseInt(checkbox.value);
                    if (value >= 1 && value <= 4) {
                        checkbox.disabled = false;
                        // Remove disabled class from parent label
                        checkbox.parentElement.classList.remove('disabled');
                    }
                });
            }

            // Regenerate problems with new filter
            createMathProblems();
        }

        /**
         * Updates the progress bar width based on answered problems
         */
        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            if (totalProblems > 0) {
                const percentage = (answeredProblems / totalProblems) * 100;
                progressBar.style.width = percentage + '%';
                console.log(`Progress: ${answeredProblems}/${totalProblems} (${percentage.toFixed(1)}%)`);

                // Check if all problems are answered
                if (answeredProblems === totalProblems) {
                    // Record end time
                    endTime = new Date();
                    console.log('All problems completed at:', endTime);

                    // Show summary modal
                    showSummaryModal();
                }
            } else {
                progressBar.style.width = '0%';
                console.log('Progress: 0/0 (0%)');
            }
        }

        /**
         * Counts the number of correct answers
         * @returns {number} The number of correct answers
         */
        function countCorrectAnswers() {
            const inputs = document.querySelectorAll('.answer-input');
            let correctCount = 0;

            inputs.forEach(input => {
                if (input.className.includes('correct-answer')) {
                    correctCount++;
                }
            });

            return correctCount;
        }

        /**
         * Calculates the time spent in minutes and seconds
         * @returns {string} Formatted time string
         */
        function calculateTimeSpent() {
            if (!startTime || !endTime) return '0 minutter';

            const timeSpentMs = endTime - startTime;
            const minutes = Math.floor(timeSpentMs / 60000);
            const seconds = Math.floor((timeSpentMs % 60000) / 1000);

            if (minutes === 0) {
                return `${seconds} sekunder`;
            } else if (seconds === 0) {
                return `${minutes} minutter`;
            } else {
                return `${minutes} minutter og ${seconds} sekunder`;
            }
        }

        /**
         * Shows the summary modal with statistics
         */
        function showSummaryModal() {
            // Calculate statistics
            const correctAnswers = countCorrectAnswers();
            const timeSpent = calculateTimeSpent();

            // Update modal content
            document.getElementById('summary-points').textContent = currentPoints;
            document.getElementById('summary-time').textContent = timeSpent;
            document.getElementById('summary-correct').textContent = `${correctAnswers} av ${totalProblems}`;
            document.getElementById('summary-streak').textContent = highestStreak;

            // Show modal
            const modal = document.getElementById('summary-modal');
            modal.style.display = 'flex';
        }

        /**
         * Closes the summary modal
         */
        function closeSummaryModal() {
            const modal = document.getElementById('summary-modal');
            modal.style.display = 'none';
        }

        /**
         * Restarts the game
         */
        function restartGame() {
            // Reset variables
            startTime = null;
            endTime = null;
            answeredProblems = 0;
            answeredIndices.clear();
            currentPoints = 0;
            currentStreak = 0;

            // Update displays
            document.getElementById('points-display').textContent = '0';
            document.getElementById('streak-display').textContent = '0';

            // Close modal
            closeSummaryModal();

            // Generate new problems
            createMathProblems();
        }

        // Run the test creation when the page loads
        window.onload = function() {
            // Reset gamification elements
            currentPoints = 0;
            currentStreak = 0;
            highestStreak = 0;
            document.getElementById('points-display').textContent = '0';
            document.getElementById('streak-display').textContent = '0';
            document.getElementById('highest-streak').textContent = '0';

            // Add event listeners for modal buttons
            document.querySelector('.close-button').addEventListener('click', closeSummaryModal);
            document.getElementById('restart-button').addEventListener('click', restartGame);

            createMathProblems();

            // Set initial toggle styling
            const isSorted = document.getElementById('order-toggle').checked;
            const toggleSwitch = document.querySelector('#order-toggle + .slider');

            if (isSorted) {
                toggleSwitch.classList.add('active');
            } else {
                toggleSwitch.classList.remove('active');
            }

            // Set initial label styling for show answers toggle
            const showResults = document.getElementById('show-results').checked;
            const showAnswersLabel = document.getElementById('show-answers-label');
            if (showResults) {
                showAnswersLabel.classList.add('active');
            } else {
                showAnswersLabel.classList.remove('active');
            }

            // Set initial label styling for large numbers toggle
            const largeNumbersOnly = document.getElementById('large-numbers-toggle').checked;
            const largeNumbersLabel = document.getElementById('large-numbers-label');
            if (largeNumbersOnly) {
                largeNumbersLabel.classList.add('active');

                // Disable and uncheck checkboxes for numbers 1-4
                document.querySelectorAll('input[name="a_number"]').forEach(checkbox => {
                    const value = parseInt(checkbox.value);
                    if (value >= 1 && value <= 4) {
                        checkbox.disabled = true;
                        checkbox.checked = false; // Uncheck the checkbox
                        // Add disabled class to parent label for styling
                        checkbox.parentElement.classList.add('disabled');
                    }
                });
            } else {
                largeNumbersLabel.classList.remove('active');

                // Enable checkboxes for numbers 1-4
                document.querySelectorAll('input[name="a_number"]').forEach(checkbox => {
                    const value = parseInt(checkbox.value);
                    if (value >= 1 && value <= 4) {
                        checkbox.disabled = false;
                        // Remove disabled class from parent label
                        checkbox.parentElement.classList.remove('disabled');
                    }
                });
            }

            // Initialize progress tracking
            updateProgressBar();
        };
    </script>
</body>
</html>
